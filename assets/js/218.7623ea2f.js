(window.webpackJsonp=window.webpackJsonp||[]).push([[218],{927:function(s,n,t){"use strict";t.r(n);var e=t(6),a=Object(e.a)({},(function(){var s=this,n=s.$createElement,t=s._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("export mongo1=192.168.95.164\nexport mongo2=192.168.95.170\nexport mongo3=192.168.95.171")]),s._v(" "),t("p",[s._v("docker run -d "),t("br"),s._v("\n-p 27017:27017 "),t("br"),s._v("\n--name mongo "),t("br"),s._v('\n--add-host "mongo1:192.168.95.164" '),t("br"),s._v('\n--add-host "mongo2:192.168.95.170" '),t("br"),s._v('\n--add-host "mongo3:192.168.95.171" '),t("br"),s._v("\nmongo:3.2.4 mongod --replSet my-mongo-set")]),s._v(" "),t("h1",{attrs:{id:"mongo1"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mongo1"}},[s._v("#")]),s._v(" mongo1")]),s._v(" "),t("p",[s._v("docker exec -it mongo mongo")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('root@ubuntu:/app# docker exec -it mongo mongo\nMongoDB shell version: 3.2.4\nconnecting to: test\nServer has startup warnings:\n2017-11-21T07:46:53.832+0000 I CONTROL  [initandlisten]\n2017-11-21T07:46:53.833+0000 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is \'always\'.\n2017-11-21T07:46:53.833+0000 I CONTROL  [initandlisten] **        We suggest setting it to \'never\'\n2017-11-21T07:46:53.833+0000 I CONTROL  [initandlisten]\n2017-11-21T07:46:53.833+0000 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is \'always\'.\n2017-11-21T07:46:53.834+0000 I CONTROL  [initandlisten] **        We suggest setting it to \'never\'\n2017-11-21T07:46:53.834+0000 I CONTROL  [initandlisten]\n> db = (new Mongo(\'localhost:27017\')).getDB(\'test\')\ntest\n> rs.initiate({\n...   "_id" : "my-mongo-set",\n...   "members" : [\n...         {"_id" : 0, "host" : "mongo1:27017"},\n...         {"_id" : 1, "host" : "mongo2:27017"},\n...         {"_id" : 2, "host" : "mongo3:27017"}\n...     ]})\n{ "ok" : 1 }\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("p",[s._v("如果出现错误：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('{\n    "ok" : 0,\n    "errmsg" : "No host described in new configuration 1 for replica set my-mongo-set maps to this node",\n    "code" : 93\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("表示host地址不存在，"),t("code",[s._v("ping")]),s._v("以下测试看看。")]),s._v(" "),t("p",[s._v("参数：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v('"_id" : "my-mongo-set",')]),s._v("的值要和启动参数的"),t("code",[s._v("--replSet")]),s._v("一样，")]),s._v(" "),t("li",[t("code",[s._v("members")]),s._v("配置项列出所有参与replica set的机器")])]),s._v(" "),t("p",[s._v("此时我们发现 shell prompt变成")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("my-mongo-set:OTHER>\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("表名我们现在位于 replset 中的 OTHER。")]),s._v(" "),t("p",[s._v("执行插入和查询，注意提示的变化：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('my-mongo-set:OTHER> db.mycollection.insert({name : \'sample\'})\nWriteResult({ "nInserted" : 1 })\nmy-mongo-set:PRIMARY> db.mycollection.find()\n{ "_id" : ObjectId("5a13e02737765db5bc7e37d8"), "name" : "sample" }\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("我们连接 mongo2 的数据库：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('my-mongo-set:PRIMARY> db2 = (new Mongo(\'mongo2:27017\')).getDB(\'test\')\ntest\nmy-mongo-set:PRIMARY> db2.setSlaveOk()\nmy-mongo-set:PRIMARY> db2.mycollection.find()\n{ "_id" : ObjectId("5a13e02737765db5bc7e37d8"), "name" : "sample" }\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[t("code",[s._v("setSlaveOk()")]),s._v(" 命令告诉控制台我们不希望在 primary 数据库里面查询。")]),s._v(" "),t("p",[s._v("连接 mongo3，看到如果不设置"),t("code",[s._v("setSlaveOk")]),s._v("则报错：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('my-mongo-set:PRIMARY>\ntest\nmy-mongo-set:PRIMARY> db3.mycollection.find()\nError: error: { "ok" : 0, "errmsg" : "not master and slaveOk=false", "code" : 13435 }\nmy-mongo-set:PRIMARY> db3.setSlaveOk()\nmy-mongo-set:PRIMARY> db3.mycollection.find()\n{ "_id" : ObjectId("5a13e02737765db5bc7e37d8"), "name" : "sample" }\nmy-mongo-set:PRIMARY>\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("h2",{attrs:{id:"生产环境需要注意的问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#生产环境需要注意的问题"}},[s._v("#")]),s._v(" 生产环境需要注意的问题")]),s._v(" "),t("ul",[t("li",[s._v("创建用户密码")]),s._v(" "),t("li",[s._v("使用 volume 存储数据")])]),s._v(" "),t("h2",{attrs:{id:"docker-compose"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose"}},[s._v("#")]),s._v(" docker-compose")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mongo")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  mongo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("3.2.4\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mongo\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mongod "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("replSet my"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("mongo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("set\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"27017:27017/tcp"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /etc/timezone"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/etc/timezone\n     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /root/app/docker/container_data/mongo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/data/db\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("extra_hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongo1:192.168.95.164"')]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongo2:192.168.95.170"')]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongo3:192.168.95.171"')]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("ul",[t("li",[t("a",{attrs:{href:"https://docs.mongodb.com/manual/replication/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docs / Replication"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"http://www.sohamkamani.com/blog/2016/06/30/docker-mongo-replica-set/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Creating a MongoDB replica set using Docker "),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://medium.com/@gargar454/deploy-a-mongodb-cluster-in-steps-9-using-docker-49205e231319",target:"_blank",rel:"noopener noreferrer"}},[s._v("Deploy a MongoDB Cluster in 9 steps Using Docker"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);n.default=a.exports}}]);