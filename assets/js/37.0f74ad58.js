(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{1053:function(s,t,a){"use strict";a.r(t);var n=a(6),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("去年一次听 AWS 的技术分享，听说了 Data Lake 的概念。如今最为流行的数据湖解决方案就是 Databricks 的 Delta Lake 了。其他的数据库解决方案，\n比如 Apache 的 Iceberg，以后有时间再学习下，最近集中学习下 Delta。")]),s._v(" "),n("p",[s._v("Delta 是 Spark 的母公司 Databricks 在 2019 年 Spark Summit 大会上开源的。"),n("a",{attrs:{href:"https://databricks.com/product/delta-lake-on-databricks",target:"_blank",rel:"noopener noreferrer"}},[s._v("官网"),n("OutboundLink")],1),s._v("\n的宣传是 "),n("code",[s._v("Brings data reliability and performance to your data lakes")]),s._v(" 可见其官方的卖点是数据可靠性和性能。")]),s._v(" "),n("p",[s._v("下面的整体架构说明 Delta 旨在现在的数据库方案上来解决现在数据库的痛点。")]),s._v(" "),n("p",[n("img",{attrs:{src:a(703),alt:""}})]),s._v(" "),n("p",[s._v("他提供了如下特性：")]),s._v(" "),n("ul",[n("li",[s._v("ACID 事务")]),s._v(" "),n("li",[s._v("DML API 更新、合并和删除数据集")]),s._v(" "),n("li",[s._v("时间旅行：数据版本和快照")]),s._v(" "),n("li",[s._v("可扩展的元数据管理")]),s._v(" "),n("li",[s._v("开放的数据格式")]),s._v(" "),n("li",[s._v("统一批处理、流处理和数据下沉")]),s._v(" "),n("li",[s._v("模式演进")]),s._v(" "),n("li",[s._v("审批历史")]),s._v(" "),n("li",[s._v("100% 兼容 Spark Api")])]),s._v(" "),n("h2",{attrs:{id:"快速开始"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#快速开始"}},[s._v("#")]),s._v(" 快速开始")]),s._v(" "),n("h3",{attrs:{id:"建表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#建表"}},[s._v("#")]),s._v(" 建表")]),s._v(" "),n("p",[s._v("和 Spark SQL 一样，只需要将格式从 "),n("code",[s._v("parquet")]),s._v(", "),n("code",[s._v("csv")]),s._v(", "),n("code",[s._v("json")]),s._v(" 转成 "),n("code",[s._v("delta")]),s._v(" 就行了。")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[s._v("events "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" spark"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("read"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("json"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/databricks-datasets/structured-streaming/events/"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nevents"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("write"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delta"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("save"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/mnt/delta/events"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nspark"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sql"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"CREATE TABLE events USING DELTA LOCATION '/mnt/delta/events/'\"")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("上面的操作就使从 JSON 数据里获取 Schema 创建了一个受管理的表。")]),s._v(" "),n("h3",{attrs:{id:"数据分割"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#数据分割"}},[s._v("#")]),s._v(" 数据分割")]),s._v(" "),n("p",[s._v("为了提高查询效率，可以指定一列或者多列来进行数据分割")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[s._v("Copy to clipboardCopy\nevents "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" spark"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("read"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("json"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/databricks-datasets/structured-streaming/events/"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nevents"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("write"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("partitionBy"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"date"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delta"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("save"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/mnt/delta/events"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nspark"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sql"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"CREATE TABLE events USING DELTA LOCATION '/mnt/delta/events/'\"")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h3",{attrs:{id:"修改表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#修改表"}},[s._v("#")]),s._v(" 修改表")]),s._v(" "),n("p",[s._v("Delta 支持丰富的改表操作")]),s._v(" "),n("h4",{attrs:{id:"流写入"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#流写入"}},[s._v("#")]),s._v(" 流写入")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" pyspark"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sql"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("types "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\n\ninputPath "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/databricks-datasets/structured-streaming/events/"')]),s._v("\n\njsonSchema "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" StructType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" StructField"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"time"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" TimestampType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" StructField"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"action"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" StringType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\neventsDF "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  spark\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("readStream\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("schema"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("jsonSchema"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Set the schema of the JSON data")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("option"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"maxFilesPerTrigger"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Treat a sequence of files as a stream by picking one file at a time")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("json"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("inputPath"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("eventsDF"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("writeStream\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("outputMode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"append"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("option"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"checkpointLocation"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/mnt/delta/events/_checkpoints/etl-from-json"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("table"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"events"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("h3",{attrs:{id:"批插更"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#批插更"}},[s._v("#")]),s._v(" 批插更")]),s._v(" "),n("p",[s._v("使用 "),n("code",[s._v("MERGE INTO")]),s._v(" 合并（插入或更新）数据到已存在的表。")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("MERGE")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" events\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USING")]),s._v(" updates\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" events"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("eventId "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" updates"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("eventId\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHEN")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("MATCHED")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("THEN")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v("\n    events"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" updates"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHEN")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("MATCHED")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("THEN")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("date")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" eventId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("date")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" eventId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("注意： 插入的时候要指定表中的所有数据。")]),s._v(" "),n("h3",{attrs:{id:"访问"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#访问"}},[s._v("#")]),s._v(" 访问")]),s._v(" "),n("p",[s._v("可以通过 DBFS 的路径或者表名来访问")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[s._v("val events "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" spark"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("read"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delta"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("load"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/mnt/delta/events"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("or")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[s._v("val events "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" spark"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("table"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"events"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"显示表历史"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#显示表历史"}},[s._v("#")]),s._v(" 显示表历史")]),s._v(" "),n("p",[s._v("通过 "),n("code",[s._v("DESCRIBE HISTORY")])]),s._v(" "),n("p",[n("img",{attrs:{src:a(704),alt:""}})]),s._v(" "),n("h3",{attrs:{id:"使用时间旅行查询早版本的数据"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用时间旅行查询早版本的数据"}},[s._v("#")]),s._v(" 使用时间旅行查询早版本的数据")]),s._v(" "),n("p",[s._v("比如")]),s._v(" "),n("ul",[n("li",[s._v("版本0 是在 "),n("code",[s._v("2019-01-29 00:37:58")])]),s._v(" "),n("li",[s._v("版本1 是在 "),n("code",[s._v("2019-01-29 00:38:10")])])]),s._v(" "),n("p",[s._v("查询版本0：")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" events VERSION "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OF")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("or")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" events "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TIMESTAMP")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OF")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2019-01-29 00:37:58'")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("NOTE: 只要在 '2019-01-29 00:37:58' to '2019-01-29 00:38:09' 内的时间都可以查询到版本0.")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[s._v("df1 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" spark"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("read"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delta"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("option"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"timestampAsOf"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" timestamp_string"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("load"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/mnt/delta/events"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndf2 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" spark"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("read"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delta"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("option"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"versionAsOf"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" version"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("load"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/mnt/delta/events"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h3",{attrs:{id:"优化表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#优化表"}},[s._v("#")]),s._v(" 优化表")]),s._v(" "),n("p",[s._v("多次操作之后会产生很对小文件，优化表可提升性能。")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OPTIMIZE")]),s._v(" delta"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mnt"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("delta"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("events"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("or")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OPTIMIZE")]),s._v(" events\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"z-order"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#z-order"}},[s._v("#")]),s._v(" Z-Order")]),s._v(" "),n("p",[s._v("为了更一步提升性能可以指定一列来帮助定位数据，")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OPTIMIZE")]),s._v(" events\n  ZORDER "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("eventType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h3",{attrs:{id:"快照清理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#快照清理"}},[s._v("#")]),s._v(" 快照清理")]),s._v(" "),n("p",[s._v("Delta 对不同版本数据进行了隔离，所以我们推荐"),n("code",[s._v("OPTIMIZE")]),s._v("，但是如果这的要清理快照可以用"),n("code",[s._v("VACUUM")]),s._v("命令")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[s._v("VACUUM events\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("or")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[s._v("VACUUM events RETAIN "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" HOURS\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])])}),[],!1,null,null,null);t.default=e.exports},703:function(s,t,a){s.exports=a.p+"assets/img/deltalakebenefits.ef4121b1.png"},704:function(s,t,a){s.exports=a.p+"assets/img/describe-history.0fdab962.png"}}]);