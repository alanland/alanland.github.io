(window.webpackJsonp=window.webpackJsonp||[]).push([[202],{911:function(t,a,e){"use strict";e.r(a);var n=e(6),s=Object(n.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("p",[t._v("从 "),e("a",{attrs:{href:"https://code.google.com/p/guava-libraries/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Guava Libraries"),e("OutboundLink")],1),t._v(" "),e("code",[t._v("13.0")]),t._v(" 智斗增加了\n"),e("a",{attrs:{href:"http://docs.guava-libraries.googlecode.com/git/javadoc/com/google/common/util/concurrent/RateLimiter.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("RateLimiter"),e("OutboundLink")],1),t._v("\n类。")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("[...] rate limiter distributes permits at a configurable rate. Each acquire() blocks if necessary until a permit is available [...] Rate limiters are often used to restrict the rate at which some physical or logical resource is accessed\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("div",{staticClass:"language-groovy line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-groovy"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" RateLimiter rateLimiter "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" RateLimiter"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("submitTasks")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    rateLimiter"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("acquire")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 也许需要等待")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" result "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" rateLimiter"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("tryAcquire")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" TimeUnit"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MILLISECONDS"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("h2",{attrs:{id:"令牌桶算法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#令牌桶算法"}},[t._v("#")]),t._v(" 令牌桶算法")]),t._v(" "),e("ol",[e("li",[t._v("每秒会有 r 个令牌放入桶中，或者说，每过 1/r 秒桶中增加一个令牌")]),t._v(" "),e("li",[t._v("桶中最多存放 b 个令牌，如果桶满了，新放入的令牌会被丢弃")]),t._v(" "),e("li",[t._v("当一个 n 字节的数据包到达时，消耗 n 个令牌，然后发送该数据包")]),t._v(" "),e("li",[t._v("如果桶中可用令牌小于 n，则该数据包将被缓存或丢弃")])]),t._v(" "),e("p",[t._v("令牌桶控制的是一个时间窗口内的通过的数据量，在 API 层面我们常说的 QPS、TPS，\n正好是一个时间窗口内的请求量或者事务量，只不过时间窗口限定在 1s 罢了。")]),t._v(" "),e("p",[t._v("现实世界的网络工程中使用的令牌桶，比概念图中的自然是复杂了许多，\n「令牌桶」的数量也不是一个而是两个，简单的算法描述可用参考中兴的期刊^1或者 RFC。")]),t._v(" "),e("p",[t._v("假如项目使用 Java 语言，我们可以轻松地借助 Guava 的 RateLimiter\n来实现基于令牌桶的流控。RateLimiter 令牌桶算法的单桶实现，\n也许是因为在 Web 应用层面单桶实现就够用了，双筒实现就属于过度设计。")]),t._v(" "),e("p",[t._v("RateLimiter 对简单的令牌桶算法做了一些工程上的优化，具体的实现是 SmoothBursty。\n需要注意的是，RateLimiter 的另一个实现 SmoothWarmingUp，就不是令牌桶了，\n而是漏桶算法。也许是出于简单起见，RateLimiter 中的时间窗口能且仅能为 1s，\n如果想搞其他时间单位的限流，只能另外造轮子。")]),t._v(" "),e("p",[t._v("SmoothBursty 积极响应李克强总理的号召，上个月的流量没用完，可以挪到下个月用。\n其实就是 SmoothBursty 有一个可以放 N 个时间窗口产生的令牌的桶，\n系统空闲的时候令牌就一直攒着，最好情况下可以扛 N 倍于限流值的高峰而不影响后续请求。\n如果不想像三峡大坝一样能扛千年一遇的洪水，可以把 N 设置为 1，\n这样就只屯一个时间窗口的令牌。")]),t._v(" "),e("p",[t._v("RateLimiter 有一个有趣的特性是「前人挖坑后人跳」，\n也就是说 RateLimiter 允许某次请求拿走超出剩余令牌数的令牌，\n但是下一次请求将为此付出代价，一直等到令牌亏空补上，\n并且桶中有足够本次请求使用的令牌为止[^2]。这里面就涉及到一个权衡，\n是让前一次请求干等到令牌够用才走掉呢，还是让它先走掉后面的请求等一等呢？\nGuava 的设计者选择的是后者，先把眼前的活干了，后面的事后面再说。")]),t._v(" "),e("hr"),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://dzone.com/articles/ratelimiter-discovering-google",target:"_blank",rel:"noopener noreferrer"}},[t._v("RateLimiter - Discovering Google Guava"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"http://blog.csdn.net/lzw_2006/article/details/51789859",target:"_blank",rel:"noopener noreferrer"}},[t._v("系统限流实践 - 应用限流"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"http://blog.csdn.net/lzw_2006/article/details/51880563",target:"_blank",rel:"noopener noreferrer"}},[t._v("系统限流实践 - 分布式限流"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"http://blog.csdn.net/lzw_2006/article/details/51909516",target:"_blank",rel:"noopener noreferrer"}},[t._v("系统限流实践 - 接入层限流(下*完结)"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=s.exports}}]);