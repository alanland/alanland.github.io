(window.webpackJsonp=window.webpackJsonp||[]).push([[62],{1047:function(e,s,a){"use strict";a.r(s);var r=a(6),t=Object(r.a)({},(function(){var e=this,s=e.$createElement,r=e._self._c||s;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("p",[e._v("Aliyun 的 Kubernetes 测试环境 CI 更新的时候，卡住了。")]),e._v(" "),r("p",[e._v("开始以为是服务器资源不足，后来查看控制台 Pod 的状态：")]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('error killing pod: [failed to "KillContainer" for "istio-proxy" with KillContainerError: "rpc error: code = Unknown \ndesc = operation timeout: context deadline exceeded" , failed to "KillContainer" for "wms" with KillContainerError:\n"rpc error: code = Unknown desc = operation timeout: context deadline exceeded" , failed to "KillPodSandbox" for \n"35ced948-e3af-11e9-aa25-eed95802c543" with KillPodSandboxError: "rpc error: code = DeadlineExceeded desc = context deadline exceeded" ]\n')])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br"),r("span",{staticClass:"line-number"},[e._v("2")]),r("br"),r("span",{staticClass:"line-number"},[e._v("3")]),r("br"),r("span",{staticClass:"line-number"},[e._v("4")]),r("br")])]),r("p",[e._v("命令行查看")]),e._v(" "),r("div",{staticClass:"language-sh line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-sh"}},[r("code",[e._v("~ kgp\nNAME                                READY   STATUS        RESTARTS   AGE\nwms-6d7bcb44f6-q2qbx                "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("/2     Terminating   "),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("          7d10h\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br"),r("span",{staticClass:"line-number"},[e._v("2")]),r("br"),r("span",{staticClass:"line-number"},[e._v("3")]),r("br")])]),r("p",[e._v("执行")]),e._v(" "),r("div",{staticClass:"language-sh line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-sh"}},[r("code",[e._v("kdelp xxx\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br")])]),r("p",[e._v("删除 Pod，Deployment 和 Service 均无法删除。")]),e._v(" "),r("p",[e._v("使用命令")]),e._v(" "),r("div",{staticClass:"language-sh line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-sh"}},[r("code",[e._v("kdelp xxx --now\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br")])]),r("p",[e._v("也不行。")]),e._v(" "),r("p",[e._v("最后执行")]),e._v(" "),r("div",{staticClass:"language-sh line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-sh"}},[r("code",[e._v("kdelp xxx --grace-period"),r("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v(" --force\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br")])]),r("p",[e._v("停止的 Pod 被删除掉了。")]),e._v(" "),r("p",[e._v("附上一个删除所有停止 Pod 的 shell 脚本：")]),e._v(" "),r("div",{staticClass:"language-sh line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-sh"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[e._v("p")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("in")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token variable"}},[r("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),e._v("kubectl get pods "),r("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token function"}},[e._v("grep")]),e._v(" Terminating "),r("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token function"}},[e._v("awk")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[e._v("'{print "),r("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$1")]),e._v("}'")]),r("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("do")]),e._v(" kubectl delete pod "),r("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$p")]),e._v(" --grace-period"),r("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),r("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v(" --force"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),r("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("done")]),e._v("\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br")])]),r("p",[e._v("重新 apply 配置，Pod 的最后5次事件是：")]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("Error creating load balancer (will retry): failed to ensure load balancer for service loghub/wms: \nupdate backend servers: error ensure vgroup: Aliyun API Error: RequestId: 62C1B690-59F7-46B4-8B45-46080E30A129 Status \nCode: 400 Code: BackendServerRelatedInstanceNumerOverLimit Message: There is backend server has reached to the quota \nlimit number of load balancers that it could be related to.. k8s/32510/wms/loghub/clusterid\nservice-controller\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br"),r("span",{staticClass:"line-number"},[e._v("2")]),r("br"),r("span",{staticClass:"line-number"},[e._v("3")]),r("br"),r("span",{staticClass:"line-number"},[e._v("4")]),r("br"),r("span",{staticClass:"line-number"},[e._v("5")]),r("br")])]),r("p",[e._v("大致意思是 load balancer 监听的后端已经到了上限，不能再添加了。（")]),e._v(" "),r("p",[e._v("随便搜了下，没有找个类似错误，在阿里云负载均衡的 "),r("a",{attrs:{href:"https://error-center.alibabacloud.com/status/product/Slb",target:"_blank",rel:"noopener noreferrer"}},[e._v("API 错误"),r("OutboundLink")],1),e._v(" 里面也没有搜索到这个错误。")]),e._v(" "),r("p",[e._v("进入阿里云负载均衡控制台](https://slb.console.aliyun.com/slb/cn-hangzhou/slbs) 找到最可以的那一个")]),e._v(" "),r("p",[r("img",{attrs:{src:a(504),alt:""}})]),e._v(" "),r("p",[e._v("删除了一个不可用的监听，再次 Apply Kubernetes 对象，成功了。")]),e._v(" "),r("p",[e._v("看了一下帮助，也没有找到关于 backend server limit 的描述，可能是找的不够详细。问题先暂且搁置。")]),e._v(" "),r("hr"),e._v(" "),r("p",[e._v("参考：")]),e._v(" "),r("ul",[r("li",[e._v("https://stackoverflow.com/questions/50336665/how-do-i-force-delete-kubernetes-pods/50338057")])])])}),[],!1,null,null,null);s.default=t.exports},504:function(e,s,a){e.exports=a.p+"assets/img/aliyun-lbs-listeners.c235c170.png"}}]);