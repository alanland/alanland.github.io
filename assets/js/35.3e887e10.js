(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{687:function(s,a,t){s.exports=t.p+"assets/img/unsync-queue1.79a1436f.png"},688:function(s,a,t){s.exports=t.p+"assets/img/unsync-queue2.262aa57e.png"},925:function(s,a,t){"use strict";t.r(a);var n=t(6),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"docker-compose-xml"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-xml"}},[s._v("#")]),s._v(" "),n("code",[s._v("docker-compose.xml")])]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2"')]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rabbitmq")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rabbitmq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("3.6.1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("management\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("container_name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rabbitmq\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostname")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rabbit80\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" always\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" RABBITMQ_DEFAULT_USER=root\n     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" RABBITMQ_DEFAULT_PASS=password\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     - RABBITMQ_ERLANG_COOKIE=xxxxxxxxxxxx")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" RABBITMQ_USE_LONGNAME=true\n     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" RABBITMQ_LOGS=/var/log/rabbitmq/rabbit.log\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"4369:4369"')]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5672:5672"')]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"15672:15672"')]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"25672:25672"')]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"35197:35197"')]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /etc/timezone"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/etc/timezone\n     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" $PWD/data/rabbitmq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/var/lib/rabbitmq\n     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" $PWD/data/rabbitmq/logs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/var/log/rabbitmq\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("extra_hosts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rabbit81:172.16.120.81"')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("h2",{attrs:{id:"修改权限"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#修改权限"}},[s._v("#")]),s._v(" 修改权限")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("chmod 600 erlang.cookie\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h2",{attrs:{id:"创建集群"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建集群"}},[s._v("#")]),s._v(" 创建集群")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('rabbit1$ docker-compose up -d\nrabbit2$ docker-compose up -d\nrabbit1$ docker exec -it rabbitmq bash\nrabbit2$ docker exec -it rabbitmq bash\n\nroot@rabbit80:/# rabbitmqctl cluster_status\nCluster status of node rabbit@rabbit80 ...\n[{nodes,[{disc,[rabbit@rabbit80]}]},\n {running_nodes,[rabbit@rabbit80]},\n {cluster_name,<<"rabbit@rabbit80">>},\n {partitions,[]},\n {alarms,[{rabbit@rabbit80,[]}]}]\n\nroot@rabbit81:/# rabbitmqctl cluster_status\nCluster status of node rabbit@rabbit81 ...\n[{nodes,[{disc,[rabbit@rabbit81]}]},\n {running_nodes,[rabbit@rabbit81]},\n {cluster_name,<<"rabbit@rabbit81">>},\n {partitions,[]},\n {alarms,[{rabbit@rabbit81,[]}]}]\n\n\nroot@rabbit81:/# rabbitmqctl  stop_app\nStopping node rabbit@rabbit81 ...\nroot@rabbit81:/# rabbitmqctl  reset\nResetting node rabbit@rabbit81 ...\nroot@rabbit81:/# rabbitmqctl  join_cluster rabbit@rabbit80\nClustering node rabbit@rabbit81 with rabbit@rabbit80 ...\nroot@rabbit81:/# rabbitmqctl  start_app\nStarting node rabbit@rabbit81 ...\n\nroot@rabbit81:/#  rabbitmqctl set_policy ha-all "^" \'{"ha-mode":"all", "ha-sync-mode":"automatic"}\'\nSetting policy "ha-all" for pattern "^" to "{\\"ha-mode\\":\\"all\\"}" with priority "0" ...\nroot@rabbit81:/#\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br")])]),n("h3",{attrs:{id:"发消息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#发消息"}},[s._v("#")]),s._v(" 发消息")]),s._v(" "),n("p",[n("code",[s._v("publish80.py")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("import pika\n\ncredentials = pika.PlainCredentials('xx', 'pwd')\nparameters = pika.ConnectionParameters('node1',\n                                       5672,\n                                       '/',\n                                       credentials)\nconnection = pika.BlockingConnection(parameters)\nchannel = connection.channel()\n\nchannel.queue_declare(queue='hello', durable=True, exclusive=False, auto_delete=False)\nchannel.basic_publish(exchange='',\n                      routing_key='hello',\n                      body='Hello World!')\nprint(\" [x] Sent 'Hello World!'\")\nconnection.close()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("python message_to_node1.py\npython message_to_node2.py\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h2",{attrs:{id:"手动添加删除用户命令"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#手动添加删除用户命令"}},[s._v("#")]),s._v(" 手动添加删除用户命令")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# Disabling guest user\ndocker exec rabbit rabbitmqctl delete_user guest\n\n# Admin user\ndocker exec rabbit rabbitmqctl add_user josuelima MyPassword999\ndocker exec rabbit rabbitmqctl set_user_tags josuelima administrator\n\n# Application user\ndocker exec rabbit rabbitmqctl add_user ruby_app SuperPassword000\ndocker exec rabbit rabbitmqctl set_permissions -p / ruby_app ".*" ".*" ".*"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("h3",{attrs:{id:"查看消息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#查看消息"}},[s._v("#")]),s._v(" 查看消息")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("root@rabbit80:/# rabbitmqctl list_queues\nListing queues ...\nhello   2\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h3",{attrs:{id:"关闭启动节点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#关闭启动节点"}},[s._v("#")]),s._v(" 关闭启动节点")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("docker exec rabbit rabbitmqctl stop_app\ndocker exec rabbit rabbitmqctl start_app\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h3",{attrs:{id:"determine-which-mirrors-are-synchronised-with-the-following-rabbitmqctl-invocation"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#determine-which-mirrors-are-synchronised-with-the-following-rabbitmqctl-invocation"}},[s._v("#")]),s._v(" determine which mirrors are synchronised with the following rabbitmqctl invocation")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rabbitmqctl list_queues name slave_pids synchronised_slave_pids\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"manually-synchronise-a-queue-with"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#manually-synchronise-a-queue-with"}},[s._v("#")]),s._v(" manually synchronise a queue with")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rabbitmqctl sync_queue name\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"cancel-synchronisation-with"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#cancel-synchronisation-with"}},[s._v("#")]),s._v(" cancel synchronisation with")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("rabbitmqctl cancel_sync_queue name\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h2",{attrs:{id:"配置自动同步-对于大量消息-自动同步会卡住系统"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置自动同步-对于大量消息-自动同步会卡住系统"}},[s._v("#")]),s._v(" 配置自动同步（对于大量消息，自动同步会卡住系统）")]),s._v(" "),n("ul",[n("li",[s._v('"ha-sync-mode": "automatic"  // default \'manual\'')])]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("rabbitmqctl set_policy ha-two "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^two\\."')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}\'')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("如果不自动同步，一个节点挂掉重启之后需要手动同步列队。")]),s._v(" "),n("p",[s._v("不然会造成消息丢失。")]),s._v(" "),n("p",[n("img",{attrs:{src:t(687),alt:""}})]),s._v(" "),n("p",[n("img",{attrs:{src:t(688),alt:""}})]),s._v(" "),n("hr"),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://www.rabbitmq.com/ha.html#eager-synchronisation",target:"_blank",rel:"noopener noreferrer"}},[s._v("Configuring Synchronisation"),n("OutboundLink")],1)]),s._v(" "),n("li",[n("a",{attrs:{href:"http://josuelima.github.io/docker/rabbitmq/cluster/2017/04/19/setting-up-a-rabbitmq-cluster-on-docker.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Setting up a RabbitMQ Cluster on Docker"),n("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=e.exports}}]);