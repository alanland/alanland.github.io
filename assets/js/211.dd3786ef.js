(window.webpackJsonp=window.webpackJsonp||[]).push([[211],{920:function(s,a,t){"use strict";t.r(a);var e=t(6),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginx"}},[s._v("#")]),s._v(" Nginx")]),s._v(" "),t("p",[t("code",[s._v("Too Many Open Files")])]),s._v(" "),t("h3",{attrs:{id:"设置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#设置"}},[s._v("#")]),s._v(" 设置")]),s._v(" "),t("ol",[t("li",[s._v("应用级别 "),t("code",[s._v("nginx.conf")])])]),s._v(" "),t("ul",[t("li",[t("code",[s._v("worker_rlimit_nofile")]),s._v(" ：限制单个工作进程打开的最大文件数")])]),s._v(" "),t("ol",{attrs:{start:"2"}},[t("li",[s._v("系统级别")])]),s._v(" "),t("ul",[t("li",[t("code",[s._v("/etc/security/limits.conf")])])]),s._v(" "),t("ol",{attrs:{start:"3"}},[t("li",[s._v("内核级别 "),t("code",[s._v("fs.file-max")])])]),s._v(" "),t("ul",[t("li",[s._v("file-max的默认值大概是系统内存的10%（系统内存以kb计算），别设置的比系统默认的还小")])]),s._v(" "),t("h3",{attrs:{id:"验证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#验证"}},[s._v("#")]),s._v(" 验证")]),s._v(" "),t("ol",[t("li",[s._v("验证nginx程序的限制")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -ef "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" nginx\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将得出的PID XXX带入下面")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/XXX/limits\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("验证系统级别的限制")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ ulimit -n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ol",{attrs:{start:"3"}},[t("li",[s._v("验证内核级别的限制")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ cat /proc/sys/fs/file-max\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"系统最大打开文件描述符数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#系统最大打开文件描述符数"}},[s._v("#")]),s._v(" 系统最大打开文件描述符数")]),s._v(" "),t("h3",{attrs:{id:"get"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#get"}},[s._v("#")]),s._v(" get")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("cat /proc/sys/fs/file-max\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"set"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#set"}},[s._v("#")]),s._v(" set")]),s._v(" "),t("p",[s._v("临时")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("echo 1000000 > /proc/sys/fs/file-max\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("永久")]),s._v(" "),t("p",[t("code",[s._v("/etc/sysctl.conf")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("fs.file-max = 1000000\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"进程最大打开文件描述符数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#进程最大打开文件描述符数"}},[s._v("#")]),s._v(" 进程最大打开文件描述符数")]),s._v(" "),t("p",[s._v("user limit中nofile的soft limit")]),s._v(" "),t("h3",{attrs:{id:"get-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#get-2"}},[s._v("#")]),s._v(" get")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("ulimit -n\nulimit -Hn # hard limit\nulimit -Sn # soft limit\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"set-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#set-2"}},[s._v("#")]),s._v(" set")]),s._v(" "),t("p",[s._v("soft limit不能大于hard limit")]),s._v(" "),t("p",[s._v("临时(当前Session)")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("ulimit -Sn 65355\nulimit -Hn 65355\nulimit -n 1800000 # 同时设置soft limit和hard limit\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("永久")]),s._v(" "),t("p",[t("code",[s._v("/etc/security/limits.conf")])]),s._v(" "),t("p",[s._v("增加：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("chanon           soft    nofile          1800000\nchanon           hard   nofile          2000000\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("重启生效。")]),s._v(" "),t("p",[s._v("设置nofile的hard limit还有一点要注意的就是hard limit\n不能大于"),t("code",[s._v("/proc/sys/fs/nr_open")]),s._v("。否则无法正常登录。")]),s._v(" "),t("h2",{attrs:{id:"查看当前系统使用的打开文件描述符数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看当前系统使用的打开文件描述符数"}},[s._v("#")]),s._v(" 查看当前系统使用的打开文件描述符数")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/sys/fs/file-nr\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5664")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("186405")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("ul",[t("li",[s._v("第一个数表示当前系统已分配使用的打开文件描述符数，")]),s._v(" "),t("li",[s._v("第二个数为分配后已释放的（目前已不再使用），")]),s._v(" "),t("li",[s._v("第三个数等于file-max。")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("ulimit")]),s._v(" -u\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"proc-目录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#proc-目录"}},[s._v("#")]),s._v(" /proc 目录")]),s._v(" "),t("p",[s._v("/proc 目录包括很多系统当前状态的参数")]),s._v(" "),t("ul",[t("li",[s._v("/proc/meminfo")]),s._v(" "),t("li",[s._v("/proc/cpuinfo")]),s._v(" "),t("li",[s._v("/proc/sys/fs/file-max #系统总限制")]),s._v(" "),t("li",[s._v("/proc/sys/fs/file-nr #整个系统目前使用的文件句柄数量")])]),s._v(" "),t("hr"),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"http://blog.csdn.net/superchanon/article/details/13303705",target:"_blank",rel:"noopener noreferrer"}},[s._v("Linux最大打开文件描述符数"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"http://blog.csdn.net/taijianyu/article/details/5976319",target:"_blank",rel:"noopener noreferrer"}},[s._v("linux /etc/security/limits.conf的相关说明"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"http://www.jianshu.com/p/23ee9db2a620",target:"_blank",rel:"noopener noreferrer"}},[s._v("使用ulimit 命令、/etc/security/limits.conf、proc 调整系统参数"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"http://blog.csdn.net/jacson_bai/article/details/42171637",target:"_blank",rel:"noopener noreferrer"}},[s._v("Nginx: Too Many Open Files解决方案汇总"),t("OutboundLink")],1)])]),s._v(" "),t("hr")])}),[],!1,null,null,null);a.default=r.exports}}]);