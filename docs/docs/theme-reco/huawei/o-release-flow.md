---
title: 发布流程
date: 2020-07-30T19:00:58.864Z
---

## 要求

1. 在库，出库，入库升级，打补丁不停机
2. 升级，打补丁回滚不停机

## 实现

支持不停机的打补丁、升级和回滚。（POC使用蓝绿发布）

:::tip
如果灰度发布验证测试可根据用户和域名来切分流量，前者需特定用户登录系统验证，后者需任意用户访问灰度域名。
:::

### 打补丁和升级流程
- 确定当前版本号；eg：`3.0.4`
- 确定补丁版本号；eg：`3.0.5`
- **开发人员** 发布并上传补丁版本镜像到容器镜像仓库
  - `docker push wms:3.0.5`
- 修改网关配置，开启 canary 的流量并重新加载配置
    ```nginx
    upstream wms {
        server 121.111.10.1:9210;
        server 121.111.10.2:9210;
        server 121.111.10.3:9210;
    }
    upstream wms_c {
       # server 121.111.10.4:9210;
       # server 121.111.10.5:9210;
        server 121.111.10.6:9210;
    }
    ```
    ```sh
    nginx -t
    nginx -s reload
    ```
- 使用新服务镜像版本
    ```yaml
    image: wms:3.0.5
    ```
- 访问 `wms-c.huawei.com` 进行功能验证
- 验证成功则开启等量服务测试，并切换域名
  - 验证失败不切换即可

## 回滚

如果发现之前未验证的业务或者程序问题，需要回滚版本。流程同升级。

:::tip 关于服务治理
线上环境如果有k8s，推荐使用 istio 来进行进行版本发布。
:::

